# plan.md

## 1. プロジェクト概要

- ターゲット: M5StickC Plus2（ESP32, M5Unified）
- センサ: 内蔵 IMU（MPU6886, M5Unified 経由）
- 出力: NeoPixel / Unit NeoHEX（Adafruit_NeoPixel 利用）
- NeoPixel データピン: GPIO32

### 一行要約

M5StickC Plus2 の加速度（重力方向の増減）に応じて、  
NeoPixel を **中心 LED をゼロ点とした双方向レベルメーター** として点灯させる。

---

## 2. ユーザーが決めている仕様（必ず優先すること）

1. **双方向レベルメーター**
   - 中心 LED をゼロ点（Δa = 0）とし、
     - 負方向の加速度変化: 先頭側（インデックス小さい側）に向かって点灯
     - 正方向の加速度変化: 末尾側（インデックス大きい側）に向かって点灯
   - 双方向に「振れる」VUメーターをイメージ。

2. **ハード・ライブラリ**
   - NeoPixel データピン: **GPIO32**
   - LED ドライバ: **Adafruit_NeoPixel**
   - IMU: **MPU6886**（M5Unified の `M5.Imu` を使用）

3. **色味**
   - オーディオ VU メーター風のグラデーション
     - 中心付近: 緑
     - 正の中間: 黄色
     - 正の端（最大レベル付近）: 赤
     - 負の中間: 青
     - 負の端（最大レベル付近）: 紫
   - 未使用 LED を「完全消灯」ではなく「弱く点灯させてグラデーションを滑らかにする」オプションを持たせても良い。

4. **キャリブレーション**
   - 静止状態で N 回サンプリングし、重力ベクトル `g0` を平均。
   - サンプル数 N は 200。
   - `g0` から重力方向の単位ベクトル `n` を求める（必要に応じて、支配軸・符号も把握）。
   - 1G の基準値を記録し、**電源断で失われるRAM上に保持**（NVSへ保存しない）。
   - 初回は BtnA でキャリブレーション完了後にLED点灯を開始し、以降も BtnA で再キャリブレーション可能にする（自動実行はしない）。

5. **設定値（config）**
   - 以下をコンフィグとして定義し、**初期値をコードで設定しておき後で変更可能（NVSに保存しない）**:
     - `led_count` 初期値: 60（先頭が負側終端）
     - `brightness_max` 初期値: 128
     - `g_range_pos` 初期値: +1.0g
     - `g_range_neg` 初期値: -1.0g（絶対値1.0を用いる）
     - 平滑化係数 `alpha` 初期値: 0.3
     - 更新周期 初期値: 20 Hz
   - configはプログラム内の定数/構造体で保持し、起動後に書き換えはしない（書き込み時のみ変更）。
   - LEDの物理向き: インデックス先頭を負側終端とする。

---

## 3. エージェントにやってほしいこと

### 3.1 メインタスク

1. **設定の定義（NVS非使用）**
   - 以下の構造体（例）を定義し、プログラム内の初期値として保持する（NVSに保存しない）。
     - `led_count` = 60
     - `brightness_max` = 128
     - `g_range_pos` = 1.0f
     - `g_range_neg` = 1.0f
     - `alpha` = 0.3f
     - `update_hz` = 20
   - configは起動後に変更しない想定だが、コード上で値を編集しやすい形（構造体/定数）にしておく。

2. **キャリブレーション処理**
   - 初回は BtnA 押下でキャリブレーションを実行し、完了するまでLED点灯を開始しない。以降も BtnA で静止状態のキャリブレーションを再実行する。
   - 手順:
     1. 所定回数（例: N=200 程度）IMU から (x, y, z) を読み、平均ベクトル `g0` を求める。
     2. `g0` を正規化して単位ベクトル `n` を求める。
        - `n = g0 / |g0|`
        - （任意）どの軸が支配的か・符号をメモしておいてもよい（デバッグ用）。
     3. `|g0|` を 1G 基準として記録するか、あるいは 1.0g とみなすかは設計に応じて選択。
     4. 結果はRAMに保持し、電源断で消える（NVSへ保存しない）。
   - キャリブレーション実行中は、LCD や LED で「Calibrating...」などの簡易表示を行っても良い。
   - **キャリブレーション完了まではLED表示を開始しない**（初回はBtnAでキャリブレーション完了後に点灯開始）。

3. **実行時の計測ロジック**
   - ループごとに IMU から (x, y, z) [g] を取得。
   - キャリブレーション済みの単位ベクトル `n` に射影して重力方向成分を得る：
     - `a_par = dot(a, n)`
   - 1G 基準からの差分（Δa）を計算：
     - `delta = a_par - 1.0f` （または `a_par - base_g`）
   - ノイズを抑えるため、`delta` に対して平滑化（EMA, ハイパスなど）を適用。
     - 例: `delta_filt = (1 - alpha) * delta_filt + alpha * delta`

4. **レベル値の正規化と LED 本数へのマッピング**
   - 正側レンジ `g_range_pos`、負側レンジ `g_range_neg` を使い、片側ごとに [-1, 1] に正規化するイメージ。
   - 例:
     - `delta > 0` の場合: `level_pos = min(delta / g_range_pos, 1.0)`
     - `delta < 0` の場合: `level_neg = min(-delta / g_range_neg, 1.0)`
   - 総 LED 数 `led_count` から中心インデックスを定義：
     - 奇数の場合: `center = led_count / 2`（整数除算）
     - 偶数の場合: 中心2個（`center-1`, `center`）を「中心LED」とみなして扱う
   - 負方向:
     - `num_neg = floor(level_neg * center)` を先頭側（index 0 → center-1）に向かって点灯。
   - 正方向:
     - `num_pos = floor(level_pos * (led_count - center - 1))` を末尾側（index led_count-1 → center+1 または center）に向かって点灯（偶数時は中心2個側から拡げる）。
   - 中心 LED は常に「ゼロ点」として、緑で点灯（偶数時は中心2個ともゼロ点扱い）。

5. **色と輝度の決定**
   - 中心 LED 付近: 緑 (#00FF00 付近)
   - 中間レベル: 黄 (#FFFF00 付近)
   - 最大レベル付近: 赤 (#FF0000 付近)
   - マッピング方法の一例:
     - レベル（0〜1）に応じて、緑→黄→赤へ線形補間。
   - 未使用 LED:
     - 「弱く点灯させる」モードを有効にし、なだらかな見た目を実現する（強度は定数で調整）。
   - `brightness_max` を上限とし、全LED同時点灯時の電流が過大にならないようにする（電源供給はユーザー配線に依存するためここでは定義しない）。

6. **操作系**
   - M5.BtnA:
     - 長押しで再キャリブレーション開始（完了までLEDは点灯開始しない）。
   - デバッグモード時（任意）:
     - LCD に `delta`, `level_pos`, `level_neg`, `num_pos`, `num_neg` などを表示し、挙動確認を容易にする（ビルド時の `#define` でデバッグモード固定）。

---

## 4. Done 条件

エージェントのタスク完了条件は次の通り。

1. **ビルド成功**
   - Arduino IDE または既定のビルドシステムでエラーなくコンパイル可能。
   - 必要なライブラリ: M5Unified, Adafruit_NeoPixel, NVS 関連（ESP32 標準）を適切に利用。

2. **動作確認（実機）**
   - 静止状態で:
     - 中心 LED 付近が点灯し、両側はレベル 0 に相当する状態になる。
   - M5StickC Plus2 を重力方向に強く押し付ける／引く動作で:
     - 一方の側の LED が外側へ向かって点灯し、最大レンジ付近で端の LED まで到達する。
   - 両極性（押し付け／浮遊）で:
     - 先頭側／末尾側がそれぞれ適切な極性に対応している。
   - BtnA による再キャリブレーションが機能し、電源断では消失して毎回やり直しになる。

3. **設定変更性**
   - `led_count`, `brightness_max`, `g_range_pos`, `g_range_neg`, `alpha` がソース内の明示的な config または構造体経由で変更可能。
   - 変更すべき場所が `README.md` またはこの `agents.md` に記載されている。

---

## 5. 実装方針の補足（エージェント向け）

- 物理的な NeoPixel / Unit NeoHEX の LED 列と、論理インデックス（0〜led_count-1）の対応をコード内で明示し、  
  「先頭側」「末尾側」「中心」の意味がわかるようにコメントする。
- 既存プロジェクトがある場合は、その構成（`src/main.cpp`, `src/...` 等）を尊重し、  
  新規機能は最小限の変更で組み込む。
- デバッグ用 `Serial.print` は、最終版では必要最低限に整理する。

---

## 6. 初期値（後から変更可能）

コードに初期値として反映するが、必要に応じて編集可能とする。

- `led_count`: 60（中心2個をゼロ点扱い、先頭が負側終端）
- `g_range_pos` / `g_range_neg`: 1.0 [g]
- `alpha`: 0.3
- `brightness_max`: 128
- `update_hz`: 20

実際の使用感（静止時の安定度、反応の速さ、眩しさ）に応じて調整する。
